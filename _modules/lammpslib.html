<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>lammpslib &mdash; ns_doc 1 documentation</title>
    
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="ns_doc 1 documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ns_doc 1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for lammpslib</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;ASE LAMMPS Calculator Library Version&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="kn">import</span> <span class="n">norm</span>
<span class="kn">from</span> <span class="nn">lammps</span> <span class="kn">import</span> <span class="n">lammps</span>
<span class="kn">from</span> <span class="nn">ase.calculators.calculator</span> <span class="kn">import</span> <span class="n">Calculator</span>
<span class="kn">from</span> <span class="nn">ase.units</span> <span class="kn">import</span> <span class="n">GPa</span>
<span class="kn">import</span> <span class="nn">ase.units</span>
<span class="kn">import</span> <span class="nn">ctypes</span>

<span class="c"># TODO</span>
<span class="c"># 1. should we make a new lammps object each time ?</span>
<span class="c"># 2. upper triangular test does not look good</span>
<span class="c"># 3. lmp object is not closed</span>
<span class="c"># 4. need a routine to get the model back from lammps</span>
<span class="c"># 5. if we send a command to lmps directly then the calculator does</span>
<span class="c">#    not know about it and the energy could be wrong.</span>

<span class="c"># 6. do we need a subroutine generator that converts a lammps string</span>
<span class="c">#   into a python function that can be called</span>


<div class="viewcode-block" id="LAMMPSlib"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib">[docs]</a><span class="k">class</span> <span class="nc">LAMMPSlib</span><span class="p">(</span><span class="n">Calculator</span><span class="p">):</span>
    <span class="sd">r&quot;&quot;&quot;</span>
<span class="sd">    LAMMPSlib Interface Documentation</span>
<span class="sd">    </span>
<span class="sd">**Introduction**</span>

<span class="sd">LAMMPSlib is an interface and calculator for LAMMPS_. LAMMPSlib uses</span>
<span class="sd">the python interface that comes with LAMMPS to solve an atoms model</span>
<span class="sd">for energy, atom forces and cell stress. This calculator creates a</span>
<span class="sd">&#39;.lmp&#39; object which is a running lammps program, so further commands</span>
<span class="sd">can be sent to this object executed until it is explicitly closed. Any</span>
<span class="sd">additional variables calculated by lammps can also be extracted. This</span>
<span class="sd">is still experimental code.</span>
<span class="sd">    </span>
<span class="sd">**Arguments**</span>

<span class="sd">=================  ==========================================================</span>
<span class="sd">Keyword                               Description</span>
<span class="sd">=================  ==========================================================</span>
<span class="sd">``lmpcmds``        list of strings of LAMMPS commands. You need to supply</span>
<span class="sd">                   enough to define the potential to be used e.g.</span>

<span class="sd">                   [&quot;pair_style eam/alloy&quot;,</span>
<span class="sd">                    &quot;pair_coeff * * potentials/NiAlH_jea.eam.alloy Ni Al&quot;]</span>

<span class="sd">``atom_types``     dictionary of &quot;atomic_symbol&quot;:lammps_atom_type pairs,</span>
<span class="sd">                   e.g. {&#39;Cu&#39;:1} to bind copper to lammps atom type 1.</span>
<span class="sd">                   Default method assigns lammps atom types in order that they</span>
<span class="sd">                   appear in the atoms model</span>

<span class="sd">``log_file``       string</span>
<span class="sd">                   path to the desired LAMMPS log file</span>

<span class="sd">``lammps_header``  string to use for lammps setup. Default is to use</span>
<span class="sd">                   metal units and simple atom simulation.</span>

<span class="sd">                   lammps_header=[&#39;units metal&#39;,</span>
<span class="sd">                                  &#39;atom_style atomic&#39;,</span>
<span class="sd">                                  &#39;atom_modify map array sort 0 0&#39;])</span>

<span class="sd">``keep_alive``     Boolean</span>
<span class="sd">                   whether to keep the lammps routine alive for more commands</span>

<span class="sd">=================  ==========================================================</span>


<span class="sd">**Requirements**</span>

<span class="sd">To run this calculator you must have LAMMPS installed and compiled to</span>
<span class="sd">enable the python interface. See the LAMMPS manual.</span>

<span class="sd">If the following code runs then lammps is installed correctly.</span>

<span class="sd">   &gt;&gt;&gt; from lammps import lammps</span>
<span class="sd">   &gt;&gt;&gt; lmp = lammps()</span>

<span class="sd">The version of LAMMPS is also important. LAMMPSlib is suitable for</span>
<span class="sd">versions after approximately 2011. Prior to this the python interface</span>
<span class="sd">is slightly different from that used by LAMMPSlib. It is not difficult</span>
<span class="sd">to change to the earlier format.</span>

<span class="sd">**LAMMPS and LAMMPSlib**</span>

<span class="sd">The LAMMPS calculator is another calculator that uses LAMMPS (the</span>
<span class="sd">program) to calculate the energy by generating input files and running</span>
<span class="sd">a separate LAMMPS job to perform the analysis. The output data is then</span>
<span class="sd">read back into python. LAMMPSlib makes direct use of the LAMMPS (the</span>
<span class="sd">program) python interface. As well as directly running any LAMMPS</span>
<span class="sd">comand line it allows the values of any of LAMMPS variables to be</span>
<span class="sd">extracted and returned to python.</span>

<span class="sd">**Example**</span>

<span class="sd">::</span>

<span class="sd">    from ase import Atom, Atoms</span>
<span class="sd">    from lammpslib import LAMMPSlib</span>

<span class="sd">    cmds = [&quot;pair_style eam/alloy&quot;,</span>
<span class="sd">            &quot;pair_coeff * * NiAlH_jea.eam.alloy Al H&quot;]</span>
<span class="sd">    </span>
<span class="sd">    a = 4.05</span>
<span class="sd">    al = Atoms([Atom(&#39;Al&#39;)], cell=(a, a, a), pbc=True)</span>
<span class="sd">    h = Atom([Atom(&#39;H&#39;)])</span>
<span class="sd">    alh = al + h</span>

<span class="sd">    lammps = LAMMPSlib(lmpcmds = cmds, logfile=&#39;test.log&#39;)</span>

<span class="sd">    alh.set_calculator(lammps)</span>
<span class="sd">    print &quot;Energy &quot;, alh.get_potential_energy()</span>

<span class="sd">    </span>
<span class="sd">**Implementation**</span>

<span class="sd">LAMMPS provides a set of python functions to allow execution of the</span>
<span class="sd">underlying C++ LAMMPS code. The functions used by the LAMMPSlib</span>
<span class="sd">interface are::</span>

<span class="sd">    from lammps import lammps</span>
<span class="sd">    </span>
<span class="sd">    lmp = lammps(cmd_args) # initiate LAMMPS object with command line args</span>

<span class="sd">    lmp.scatter_atoms(&#39;x&#39;,1,3,positions) # atom coords to LAMMPS C array</span>
<span class="sd">    lmp.command(cmd) # executes a one line cmd string</span>
<span class="sd">    lmp.extract_variable(...) # extracts a per atom variable</span>
<span class="sd">    lmp.extract_global(...) # extracts a global variable</span>
<span class="sd">    lmp.close() # close the lammps object</span>
<span class="sd">    </span>
<span class="sd">For a single atom model the following lammps file commands would be run</span>
<span class="sd">by invoking the get_potential_energy() method::</span>

<span class="sd">    units metal</span>
<span class="sd">    atom_style atomic</span>
<span class="sd">    atom_modify map array sort 0 0</span>
<span class="sd">    </span>
<span class="sd">    region cell prism 0 xhi 0 yhi 0 zhi xy xz yz units box</span>
<span class="sd">    create_box 1 cell</span>
<span class="sd">    create_atoms 1 single 0 0 0 units box</span>
<span class="sd">    mass * 1.0</span>

<span class="sd">    ## user lmpcmds get executed here</span>
<span class="sd">    pair_style eam/alloy</span>
<span class="sd">    pair_coeff * * lammps/potentials/NiAlH_jea.eam.alloy Al</span>
<span class="sd">    ## end of user lmmpcmds</span>

<span class="sd">    run 0</span>


<span class="sd">**Notes**</span>

<span class="sd">.. _LAMMPS: http://lammps.sandia.gov/</span>

<span class="sd">* Units: The default lammps_header sets the units to Angstrom and eV</span>
<span class="sd">  and for compatibility with ASE Stress is in GPa.</span>

<span class="sd">* The global energy is currently extracted from LAMMPS using</span>
<span class="sd">  extract_variable since lammps.lammps currently extract_global only</span>
<span class="sd">  accepts the following [&#39;dt&#39;, &#39;boxxlo&#39;, &#39;boxxhi&#39;, &#39;boxylo&#39;, &#39;boxyhi&#39;,</span>
<span class="sd">  &#39;boxzlo&#39;, &#39;boxzhi&#39;, &#39;natoms&#39;, &#39;nlocal&#39;].</span>

<span class="sd">* If an error occurs while lammps is in control it will crash</span>
<span class="sd">  Python. Check the output of the log file to find the lammps error.</span>

<span class="sd">* If the are commands directly sent to the LAMMPS object this may</span>
<span class="sd">  change the energy value of the model. However the calculator will not</span>
<span class="sd">  know of it and still return the original energy value.</span>

<span class="sd">End LAMMPSlib Interface Documentation</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">implemented_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">,</span> <span class="s">&#39;forces&#39;</span><span class="p">,</span> <span class="s">&#39;stress&#39;</span><span class="p">]</span>

    <span class="c">#NB</span>
    <span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">initialized</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">default_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">atom_types</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">log_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">lammps_name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
        <span class="n">keep_alive</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">lammps_header</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;units metal&#39;</span><span class="p">,</span>
                       <span class="s">&#39;atom_style atomic&#39;</span><span class="p">,</span>
                       <span class="s">&#39;atom_modify map array sort 0 0&#39;</span><span class="p">])</span>

<div class="viewcode-block" id="LAMMPSlib.set_cell"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib.set_cell">[docs]</a>    <span class="k">def</span> <span class="nf">set_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">change</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_cell</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_cell</span><span class="p">())</span>
        <span class="n">xhi</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">yhi</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">zhi</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">xz</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">yz</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">change</span><span class="p">:</span>
            <span class="n">cell_cmd</span> <span class="o">=</span> <span class="s">&#39;change_box all     x final 0 {} y final 0 {} z final 0 {}      xy final {} xz final {} yz final {}&#39;</span>\
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xhi</span><span class="p">,</span> <span class="n">yhi</span><span class="p">,</span> <span class="n">zhi</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">xz</span><span class="p">,</span> <span class="n">yz</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># just in case we&#39;ll want to run with a funny shape box, and here command will only happen once, and before any calculation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;box tilt large&#39;</span><span class="p">)</span>
            <span class="n">cell_cmd</span> <span class="o">=</span> <span class="s">&#39;region cell prism    0 {} 0 {} 0 {}     {} {} {}     units box&#39;</span>\
                <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">xhi</span><span class="p">,</span> <span class="n">yhi</span><span class="p">,</span> <span class="n">zhi</span><span class="p">,</span> <span class="n">xy</span><span class="p">,</span> <span class="n">xz</span><span class="p">,</span> <span class="n">yz</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">cell_cmd</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LAMMPSlib.calculate"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib.calculate">[docs]</a>    <span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">system_changes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">propagate</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">system_changes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="LAMMPSlib.propagate"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib.propagate">[docs]</a>    <span class="k">def</span> <span class="nf">propagate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">system_changes</span><span class="p">,</span> <span class="n">n_steps</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;&quot;atoms: Atoms object</span>
<span class="sd">            Contains positions, unit-cell, ...</span>
<span class="sd">        properties: list of str</span>
<span class="sd">            List of what needs to be calculated.  Can be any combination</span>
<span class="sd">            of &#39;energy&#39;, &#39;forces&#39;, &#39;stress&#39;, &#39;dipole&#39;, &#39;charges&#39;, &#39;magmom&#39;</span>
<span class="sd">            and &#39;magmoms&#39;.</span>
<span class="sd">        system_changes: list of str</span>
<span class="sd">            List of what has changed since last calculation.  Can be</span>
<span class="sd">            any combination of these five: &#39;positions&#39;, &#39;numbers&#39;, &#39;cell&#39;,</span>
<span class="sd">            &#39;pbc&#39;, &#39;charges&#39; and &#39;magmoms&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_changes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="o">=</span> <span class="bp">None</span>

	<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_lammps</span><span class="p">()</span>

	<span class="c">#NB</span>
	<span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">initialized</span><span class="p">:</span>
	   <span class="bp">self</span><span class="o">.</span><span class="n">initialise_lammps</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># still need to reset cell</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">change</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">pos</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>

        <span class="c"># If necessary, transform the positions to new coordinate system</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">pos</span><span class="p">))</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="c"># Convert ase position matrix to lammps-style position array</span>
        <span class="n">lmp_positions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pos</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

        <span class="c"># Convert that lammps-style array into a C object</span>
        <span class="n">lmp_c_positions</span> <span class="o">=</span>\
            <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lmp_positions</span><span class="p">))(</span><span class="o">*</span><span class="n">lmp_positions</span><span class="p">)</span>
<span class="c">#        self.lmp.put_coosrds(lmp_c_positions)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">scatter_atoms</span><span class="p">(</span><span class="s">&#39;x&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">lmp_c_positions</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">n_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_velocities</span><span class="p">()</span><span class="o">/</span><span class="p">(</span><span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Ang</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0e-12</span><span class="o">*</span><span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>

            <span class="c"># If necessary, transform the velocities to new coordinate system</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span> <span class="p">)</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">vel</span><span class="p">)</span>

            <span class="c"># Convert ase velocities matrix to lammps-style velocities array</span>
            <span class="n">lmp_velocities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vel</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>

            <span class="c"># Convert that lammps-style array into a C object</span>
            <span class="n">lmp_c_velocities</span> <span class="o">=</span>\
                <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lmp_velocities</span><span class="p">))(</span><span class="o">*</span><span class="n">lmp_velocities</span><span class="p">)</span>
<span class="c">#            self.lmp.put_coosrds(lmp_c_velocities)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">scatter_atoms</span><span class="p">(</span><span class="s">&#39;v&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">lmp_c_velocities</span><span class="p">)</span>
 
        <span class="c"># Run for 0 time to calculate</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;timestep </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dt</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0e-12</span><span class="o">*</span><span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;run </span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">n_steps</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_steps</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># TODO this must be slower than native copy, but why is it broken?</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">gather_atoms</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span><span class="p">)</span>
            <span class="n">atoms</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
            <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">gather_atoms</span><span class="p">(</span><span class="s">&quot;v&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span><span class="p">)</span>
            <span class="n">atoms</span><span class="o">.</span><span class="n">set_velocities</span><span class="p">(</span><span class="n">vel</span><span class="o">*</span><span class="p">(</span><span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">Ang</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0e-12</span><span class="o">*</span><span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">s</span><span class="p">)))</span>

        <span class="c"># Extract the forces and energy</span>
<span class="c">#        if &#39;energy&#39; in properties:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">extract_variable</span><span class="p">(</span><span class="s">&#39;pe&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="c">#            self.results[&#39;energy&#39;] = self.lmp.extract_global(&#39;pe&#39;, 0)</span>
            
<span class="c">#        if &#39;stress&#39; in properties:</span>
        <span class="n">stress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="c"># stress_vars = [&#39;pxx&#39;, &#39;pyy&#39;, &#39;pzz&#39;, &#39;pxy&#39;, &#39;pxz&#39;, &#39;pyz&#39;]</span>
        <span class="n">stress_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;pxx&#39;</span><span class="p">,</span> <span class="s">&#39;pyy&#39;</span><span class="p">,</span> <span class="s">&#39;pzz&#39;</span><span class="p">,</span> <span class="s">&#39;pyz&#39;</span><span class="p">,</span> <span class="s">&#39;pxz&#39;</span><span class="p">,</span> <span class="s">&#39;pxy&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stress_vars</span><span class="p">):</span>
            <span class="n">stress</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">extract_variable</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="n">stress_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
	<span class="n">stress_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">stress_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">stress_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span><span class="p">))</span>
	<span class="n">stress</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
	<span class="n">stress</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">stress</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">stress</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">stress</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
	<span class="n">stress</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>

        <span class="c"># 1 bar (used by lammps for metal units) = 1e-4 GPa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;stress&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stress</span> <span class="o">*</span> <span class="o">-</span><span class="mf">1e-4</span> <span class="o">*</span> <span class="n">GPa</span>

<span class="c">#        if &#39;forces&#39; in properties:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">force_vars</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;fx&#39;</span><span class="p">,</span> <span class="s">&#39;fy&#39;</span><span class="p">,</span> <span class="s">&#39;fz&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">force_vars</span><span class="p">):</span>
            <span class="n">f</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">extract_variable</span><span class="p">(</span>
                    <span class="n">var</span><span class="p">,</span> <span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[:</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)])</span>
            
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;forces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s">&#39;forces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">keep_alive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="LAMMPSlib.is_upper_triangular"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib.is_upper_triangular">[docs]</a>    <span class="k">def</span> <span class="nf">is_upper_triangular</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;test if 3x3 matrix is upper triangular&quot;&quot;&quot;</span>
        
        <span class="k">def</span> <span class="nf">near0</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Test if a float is within .00001 of 0&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.00001</span>
        
        <span class="k">return</span> <span class="n">near0</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">near0</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="n">near0</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</div>
<div class="viewcode-block" id="LAMMPSlib.convert_cell"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib.convert_cell">[docs]</a>    <span class="k">def</span> <span class="nf">convert_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ase_cell</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert a parallel piped (forming right hand basis)</span>
<span class="sd">        to lower triangular matrix LAMMPS can accept. This</span>
<span class="sd">        function transposes cell matrix so the bases are column vectors</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">ase_cell</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_upper_triangular</span><span class="p">(</span><span class="n">cell</span><span class="p">):</span>
            <span class="c"># rotate bases into triangular matrix</span>
            <span class="n">tri_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">B</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
            <span class="n">tri_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">Ahat</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
            <span class="n">AxBhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">))</span>
            <span class="n">tri_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">Ahat</span><span class="p">)</span>
            <span class="n">tri_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">Ahat</span><span class="p">,</span> <span class="n">B</span><span class="p">))</span>
            <span class="n">tri_mat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">Ahat</span><span class="p">)</span>
            <span class="n">tri_mat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">AxBhat</span><span class="p">,</span> <span class="n">Ahat</span><span class="p">))</span>
            <span class="n">tri_mat</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">AxBhat</span><span class="p">))</span>

            <span class="c"># create and save the transformation for coordinates</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">ase_cell</span><span class="p">)</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">)])</span>
            <span class="n">trans</span> <span class="o">=</span> <span class="n">trans</span> <span class="o">/</span> <span class="n">volume</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">coord_transform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tri_mat</span> <span class="p">,</span> <span class="n">trans</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">tri_mat</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cell</span>
</div>
<div class="viewcode-block" id="LAMMPSlib.lammpsbc"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib.lammpsbc">[docs]</a>    <span class="k">def</span> <span class="nf">lammpsbc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pbc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pbc</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;p&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;s&#39;</span>
</div>
<div class="viewcode-block" id="LAMMPSlib.start_lammps"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib.start_lammps">[docs]</a>    <span class="k">def</span> <span class="nf">start_lammps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># start lammps process</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">log_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-echo&#39;</span><span class="p">,</span> <span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="s">&#39;-log&#39;</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">,</span> <span class="s">&#39;-screen&#39;</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd_args</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;-echo&#39;</span><span class="p">,</span> <span class="s">&#39;log&#39;</span><span class="p">,</span> <span class="s">&#39;-log&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">log_file</span><span class="p">,</span>
                        <span class="s">&#39;-screen&#39;</span><span class="p">,</span> <span class="s">&#39;none&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cmd_args</span> <span class="o">=</span> <span class="n">cmd_args</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;lmp&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span> <span class="o">=</span> <span class="n">lammps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lammps_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmd_args</span><span class="p">)</span>

        <span class="c"># Use metal units: Angstrom, ps, and eV</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lammps_header</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> <span class="s">&quot;lammps_header_extra&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lammps_header_extra</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lammps_header_extra</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="o">=</span><span class="bp">True</span>
</div>
<div class="viewcode-block" id="LAMMPSlib.initialise_lammps"><a class="viewcode-back" href="../lammpslib.html#lammpslib.LAMMPSlib.initialise_lammps">[docs]</a>    <span class="k">def</span> <span class="nf">initialise_lammps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atoms</span><span class="p">):</span>

        <span class="c"># Initialising commands</span>

        <span class="c"># if the boundary command is in the supplied commands use that</span>
        <span class="c"># otherwise use atoms pbc</span>
        <span class="n">pbc</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_pbc</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lmpcmds</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;boundary&#39;</span> <span class="ow">in</span> <span class="n">cmd</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span>
                <span class="s">&#39;boundary &#39;</span> <span class="o">+</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">lammpsbc</span><span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="n">pbc</span><span class="p">]))</span>

        <span class="c"># Initialize cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_cell</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>

        <span class="c"># The default atom_types has atom type in alphabetic order</span>
        <span class="c"># by atomic symbol</span>
        <span class="n">symbols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_chemical_symbols</span><span class="p">())</span>

        <span class="c"># if the dictionary of types has not already been specified</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">atom_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">symbols</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sym</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atom_types</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c"># Initialize box</span>
        <span class="n">n_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">)</span>
        <span class="n">types_command</span> <span class="o">=</span> <span class="s">&#39;create_box {} cell&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n_types</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">types_command</span><span class="p">)</span>

        <span class="c"># Initialize the atoms with their types</span>
        <span class="c"># positions do not matter here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;echo none&#39;</span><span class="p">)</span> <span class="c"># don&#39;t echo the atom positions</span>
        <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;create_atoms {} single 0.0 0.0 0.0  units box&#39;</span><span class="o">.</span>\
                <span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">sym</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;echo log&#39;</span><span class="p">)</span> <span class="c"># turn back on</span>

        <span class="c"># Set masses</span>
        <span class="n">masses</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sym</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atoms</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">symbols</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">sym</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;mass </span><span class="si">%d</span><span class="s"> </span><span class="si">%f</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atom_types</span><span class="p">[</span><span class="n">sym</span><span class="p">],</span> <span class="n">masses</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0e-3</span> <span class="o">*</span> <span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">kg</span> <span class="o">/</span><span class="n">ase</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">mol</span><span class="p">)))</span> <span class="c"># convert from amu (ASE) to g/mole (metal))</span>
                    <span class="k">break</span>

        <span class="c"># execute the user commands</span>
        <span class="k">for</span> <span class="n">cmd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">lmpcmds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

        <span class="c"># Define force &amp; energy variables for extraction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable pxx equal pxx&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable pyy equal pyy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable pzz equal pzz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable pxy equal pxy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable pxz equal pxz&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable pyz equal pyz&#39;</span><span class="p">)</span>

        <span class="c"># I am not sure why we need this next line but LAMMPS will</span>
        <span class="c"># raise an error if it is not there. Perhaps it is needed to</span>
        <span class="c"># ensure the cell stresses are calculated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;thermo_style custom pe pxx&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable fx atom fx&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable fy atom fy&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable fz atom fz&#39;</span><span class="p">)</span>

        <span class="c"># do we need this if we extract from a global ?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lmp</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="s">&#39;variable pe equal pe&#39;</span><span class="p">)</span>

	<span class="bp">self</span><span class="o">.</span><span class="n">initialized</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c">#print(&#39;done loading lammpslib&#39;)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">ns_doc 1 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, livia.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>